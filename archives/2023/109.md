---
title: Mercurial 使用记录
number: '#109'
link: 'https://github.com/toFrankie/blog/issues/109'
created_at: '2023-02-25 20:56:02'
updated_at: '2023-12-17 15:09:47'
labels:
  - Git
  - '2022'
---
![配图源自 Freepik](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2023/12/1702748536703.jpg)


[Mercurial](https://www.mercurial-scm.org/) 跟 Git 一样，也是一个分布式版本控制系统，它使用「汞」的元素符号「Hg」的小写形式  `hg` 作为命令。

## 安装

使用 Homebrew 进行安装，其他方式请看[这里](https://www.mercurial-scm.org/downloads)。

```shell
$ brew install mercurial
```

## 初始化

在全局配置文件 `~/.hgrc`（若无则新增），配置提交者的用户名和邮箱。比如：

```ini
[ui]
username = Frankie <frankie@example.com>
```

> Use `hg config` to configure a user name, email address, editor, and other preferences once per machine.

```shell
# 创建
$ hg init

# 克隆
$ hg clone <repo-address> [repo-name]
```

## 分支操作

### 创建分支

```shell
# 创建新分支
$ hg branch <branch-name>

# 只有提交一个 commit，新分支才算真正被创建。
# 可提交一个「空」的 commit，比如：hg commit
$ hg commit -m "create '<branch-name>' branch"

# 提交新分支到远程仓库
$ hg push --new-branch
```

### 查看/切换分支

```shell
# 查看当前分支
$ hg branch

# 查看所有分支
$ hg branches

# 切换分支
$ hg checkout <branch-name>
```

在 Git 中，我们可以使用 `git stash` 将所有未提交的修改（工作区和暂存区）保存至堆栈中，用于后续恢复当前工作目录。Mercurial 也有类似的命令：

```shell
$ hg shelve --name <name>
$ hg unshelve <name>
```

其中 `--name` 参数是可选的，也可简写为 `-n`。

### 合并分支、关闭分支

假设有 `default` 和 `feature` 分支，将 `feature` 合并至 `default`。操作如下：

```shell
# 切换至 feature 分支，提交一个空 Commit 来关闭当前分支
$ hg checkout feature
$ hg commit -m 'xxx' --close-branch
$ hg push

# 再切回 default 分支，然后 merge feature 分支
$ hg checkout default
$ hg merge feature
$ hg commit -m 'xxx'
$ hg push
```

我们知道，在 Git 里可以通过 `git branch -d <branch-name>` 或 `git push origin --delete <branch-name>` 等方式删除本地分支或远程分支。**但 Mercurial 里没有删除分支的概念**。

已 Git 为例，一个仓库通常有 `Master Branch` 和 `Develop Branch` 两个主干分支，还应该有 `Feature branches`、`Release branches`、`Hotfix branches` 等辅助分支。当辅助分支完成使命后，它们将会被合并至主干分支，再进行删除。

在 Mercurial 里，用「关闭」的概念来表示一个分支的结束。如果一个分支该结束了，我们可以提交一个空的 Commit 来关闭它，需加上 `--close-branch` 参数，比如 `hg commit -m 'xxx' --close-branch`。如果在已关闭的分支上提交新的 Commit，该分支会 Reopen。

### 代码合并工具

篇幅可能有点长，放在文末。

## 代码提交

```shell
# 普通提交
$ hg commit -m 'some message...'

# 空 commit 提交
$ hg commit -m 'some message...' --config ui.allowemptycommit=1
```

刚创建的分支，是可以直接 `hg commit -m 'xxx'` 提交一个空 Commit 的。但在已有 Commit Log 的分支上，如果没有文件的改动，直接提交空 Commit 会失败并提示 `nothing changed`。针对有需要提交空 Commit 的场景，可以在末尾加上 `--config ui.allowemptycommit=1`。

撤销上一个提交

```shell
$ hg rollback
```

## 代码推送

```shell
# 切换至某分支
$ hg checkout <branch-name>

# 推送当前分支至远程仓库。若远程仓库中没有的新分支，则需要加上 --new-branch 参数。
$ hg push
```

## 代码拉取与更新

```shell
# 拉取代码（类似 git fetch）
$ hg pull

# 拉取代码后，更新本地分支
$ hg update

# 以上两步等价于
$ hg pull -u
```

## 查看提交记录

```shell
$ hg log
$ hg log -G # or hg log --graph
```
更多请看[这里](https://swcarpentry.github.io/hg-novice/12-merges/)。

## 取消文件跟踪

通常来说，我们会将不需要提交到远程仓库的文件或目录添加到 `.hgignore` 文件中。对于已跟踪的文件（tracked file），若要取消某个文件或目录的跟踪，只更新 `.hgigonre` 是不行的，还要用到 `hg remove` 或 `hg forget` 命令。

```shell
# 取消跟踪，并删除本地文件
$ hg remove <tracked-file>

# 取消跟踪，但不删除本地文件
$ hg forget <tracked-file>
```

分别对应 Git 的 `git rm` 和 `git rm --cache`，根据实际需求选择即可。更多请看[这里](https://www.selenic.com/mercurial/hg.1.html#forget)。

## 其他

- `hg status` shows the status of a repository.
- `hg add` puts files in the staging area.
- `hg commit` saves the staged content as a new commit in the local repository.
- `hg log` lists all changes committed to a repository, starting with the most recent.

## 代码合并工具

Mercurial 没有内置任何交互式的合并程序，但可以依赖外部工具来实现。

> Mercurial does not include any interactive merge programs but relies on external tools for that.

默认情况下，如果合并时存在冲突，会被标记为失败，需要进一步手动解决冲突。


比如，当前有 default 和 develop 两个分支，现在要将 develop 合并至 default 分支里，而且两个分支是存在冲突的。

```shell
$ hg checkout default

$ hg merge develop
```

默认情况下，它使用的是 vimdiff 工具，如下：

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2023/12/1702793890728.png)

左侧是当前分支，也就是合并结果。中间是要合并进来的分支。右侧是两个分支的共同祖先节点。

> 鄙人对 vim 操作不熟练，面对复杂的合并时，用起来很不顺手，因此另寻她路。

### 使用 VS Code

就 Git 来说，在 VS Code 上的合并体验还不错，现在也支持 [3-way merge](https://code.visualstudio.com/updates/v1_69#_3-way-merge-editor) 方式。

![](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2023/12/1702795478521.png)

由于 VS Code 并没有内置支持 Mercurial 版本管理，因此要安装 Hg 相关扩展。

1. 安装 Hg 相关的 VS Code 扩展（比如[这个](https://marketplace.visualstudio.com/items?itemName=vivekvijayan.hg)），以便在资源管理器面板查看变更等，像 Git 一样。
2. 在 `~/.hgrc` 以下配置。

```ini
[ui]
merge = :merge
```

现在执行 Merge 操作时，就能像 Git 一样操作了，操作完成后，点击冲突文件左侧的 ✔ 表示 Merge Complete。也可以用 `hg resolve` 来代替。 

![image.png](https://cdn.jsdelivr.net/gh/toFrankie/blog@main/images/2023/12/1702796441225.png)

### 使用 3-way merge

还是使用 VS Code。

## References

* [Mercurial SCM](https://www.mercurial-scm.org/)
* [Mercurial(Hg) 中文网](https://www.iiyouu.com/)
* [How to correctly close a feature branch in Mercurial?](https://stackoverflow.com/questions/2237222/how-to-correctly-close-a-feature-branch-in-mercurial)
